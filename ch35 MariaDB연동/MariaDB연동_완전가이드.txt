WPF MariaDB 연동 완전 가이드
=====================================================

ch35 MariaDB연동 프로젝트 - 데이터베이스 CRUD 애플리케이션

========== 프로젝트 개요 ==========

목적:
- WPF에서 MariaDB 데이터베이스 연동
- CRUD 작업 (Create, Read, Update, Delete)
- ADO.NET 기본 사용법 학습

기술 스택:
- WPF (.NET 9)
- MariaDB (MySQL 호환)
- MySqlConnector (NuGet 패키지)
- ADO.NET (데이터베이스 액세스)

프로젝트 구조:
ch35 MariaDB연동/
├── MainWindow.xaml         (UI - DataGrid + 입력 폼)
├── MainWindow.xaml.cs      (로직 - CRUD 작업)
└── App.xaml                (애플리케이션 진입점)


========== MariaDB 설정 ==========

1. MariaDB 설치:
   - Windows: https://mariadb.org/download/
   - 포트: 3306 (기본) 또는 3307 (이 예제)
   - Root 비밀번호 설정

2. 데이터베이스 생성:
   CREATE DATABASE study;
   USE study;

3. 테이블 생성:
   CREATE TABLE person (
       ID INT AUTO_INCREMENT PRIMARY KEY,
       Name VARCHAR(100),
       Age INT,
       Address VARCHAR(200)
   );

4. 샘플 데이터:
   INSERT INTO person (Name, Age, Address) VALUES
   ('홍길동', 30, '서울'),
   ('김철수', 25, '부산'),
   ('이영희', 28, '대구');

5. 확인:
   SELECT * FROM person;


========== NuGet 패키지 설치 ==========

1. Visual Studio:
   - 솔루션 탐색기에서 프로젝트 우클릭
   - "NuGet 패키지 관리"
   - "찾아보기"
   - "MySqlConnector" 검색
   - 설치

2. 패키지 관리자 콘솔:
   Install-Package MySqlConnector

3. .NET CLI:
   dotnet add package MySqlConnector

4. .csproj 파일:
   <ItemGroup>
     <PackageReference Include="MySqlConnector" Version="2.x.x" />
   </ItemGroup>


========== ADO.NET 핵심 개념 ==========

ADO.NET (ActiveX Data Objects .NET):
- .NET의 데이터베이스 액세스 기술
- 연결 지향 (Connected) 및 비연결 (Disconnected)
- SQL Server, MySQL, PostgreSQL 등 지원

핵심 클래스:

1. MySqlConnection:
   - 데이터베이스 연결 관리
   - Open(), Close()

2. MySqlCommand:
   - SQL 명령 실행
   - ExecuteReader(), ExecuteNonQuery(), ExecuteScalar()

3. MySqlDataReader:
   - 순방향, 읽기 전용 데이터 스트림
   - 메모리 효율적

4. DataTable:
   - 메모리 내 데이터베이스 테이블
   - 비연결 모드
   - DataGrid 바인딩

5. MySqlParameter:
   - SQL Injection 방지
   - 매개변수화된 쿼리


========== 연결 문자열 (Connection String) ==========

기본 형식:
"Server=localhost;Uid=root;Database=study;port=3307;pwd=1234"

구성 요소:
- Server: 서버 주소 (localhost, IP, 도메인)
- Uid: 사용자 ID (root, 사용자명)
- Database: 데이터베이스 이름
- port: 포트 번호 (3306 기본, 3307 사용자 설정)
- pwd/Password: 비밀번호

추가 옵션:
- CharSet=utf8mb4: 문자 인코딩 (한글 지원)
- SslMode=None/Preferred/Required: SSL 연결
- Pooling=true: 연결 풀링 (기본)
- MinPoolSize=0, MaxPoolSize=100: 풀 크기
- ConnectionTimeout=30: 연결 타임아웃 (초)

예제:
var connectionString = "Server=localhost;Uid=root;Database=study;port=3307;pwd=1234;CharSet=utf8mb4";
var connection = new MySqlConnection(connectionString);


========== CRUD 작업 ==========

CREATE (삽입):
```csharp
MySqlCommand command = new MySqlCommand(
    "INSERT INTO person(Name, Age, Address) VALUES (@name, @age, @address)", 
    connection);
command.Parameters.AddWithValue("@name", "홍길동");
command.Parameters.AddWithValue("@age", 30);
command.Parameters.AddWithValue("@address", "서울");
connection.Open();
command.ExecuteNonQuery();
connection.Close();
```

READ (조회):
```csharp
MySqlCommand command = new MySqlCommand("SELECT * FROM person", connection);
connection.Open();
MySqlDataReader reader = command.ExecuteReader();
while (reader.Read())
{
    int id = reader.GetInt32("ID");
    string name = reader.GetString("Name");
    // ...
}
connection.Close();
```

UPDATE (수정):
```csharp
MySqlCommand command = new MySqlCommand(
    "UPDATE person SET Name=@name, Age=@age, Address=@address WHERE ID=@id", 
    connection);
command.Parameters.AddWithValue("@name", "김길동");
command.Parameters.AddWithValue("@age", 31);
command.Parameters.AddWithValue("@address", "부산");
command.Parameters.AddWithValue("@id", 1);
connection.Open();
command.ExecuteNonQuery();
connection.Close();
```

DELETE (삭제):
```csharp
MySqlCommand command = new MySqlCommand("DELETE FROM person WHERE ID=@id", connection);
command.Parameters.AddWithValue("@id", 1);
connection.Open();
command.ExecuteNonQuery();
connection.Close();
```


========== DataTable과 DataGrid ==========

DataTable:
- 메모리 내 데이터베이스 테이블
- 비연결 모드 (데이터베이스 연결 불필요)
- DataGrid, ListView 바인딩 용이

사용:
```csharp
DataTable dataTable = new DataTable();
MySqlCommand command = new MySqlCommand("SELECT * FROM person", connection);
connection.Open();
MySqlDataReader reader = command.ExecuteReader();
dataTable.Load(reader);
connection.Close();

Grid.ItemsSource = dataTable.DefaultView;
```

DataGrid:
- 데이터를 표 형태로 표시
- 자동 열 생성 (AutoGenerateColumns=True)
- 정렬, 필터링, 편집 지원

XAML:
```xaml
<DataGrid Name="Grid" AutoGenerateColumns="True" IsReadOnly="False"/>
```


========== 매개변수화된 쿼리 (Parameterized Query) ==========

?? SQL Injection 취약점:
```csharp
// 나쁜 예 (위험!)
string sql = $"SELECT * FROM person WHERE Name = '{name}'";
```

공격:
```csharp
string name = "' OR '1'='1"; // 모든 데이터 조회
string name = "'; DROP TABLE person; --"; // 테이블 삭제!
```

? 안전한 코드:
```csharp
MySqlCommand command = new MySqlCommand("SELECT * FROM person WHERE Name = @name", connection);
command.Parameters.AddWithValue("@name", name);
```

장점:
1. SQL Injection 방지 (보안)
2. 타입 안전성
3. 성능 (쿼리 재사용)
4. 가독성


========== 예외 처리 ==========

try-catch-finally 패턴:
```csharp
try
{
    connection.Open();
    command.ExecuteNonQuery();
    MessageBox.Show("성공");
}
catch (MySqlException ex)
{
    MessageBox.Show($"데이터베이스 오류: {ex.Message}");
}
catch (Exception ex)
{
    MessageBox.Show($"예상치 못한 오류: {ex.Message}");
}
finally
{
    if (connection.State == ConnectionState.Open)
    {
        connection.Close();
    }
    LoadData(); // 데이터 새로고침
}
```

주요 예외:
- MySqlException: 데이터베이스 오류
  - 1062: 중복 키
  - 1451: 외래 키 제약 위반
  - 1064: SQL 구문 오류
- InvalidOperationException: 연결 상태 오류
- FormatException: 데이터 형식 오류


========== using 문 (리소스 관리) ==========

권장 패턴:
```csharp
using (var connection = new MySqlConnection(connectionString))
using (var command = new MySqlCommand(sql, connection))
{
    connection.Open();
    command.ExecuteNonQuery();
} // 자동으로 Dispose 호출 (연결 닫기)
```

장점:
- 자동 리소스 해제
- 예외 발생 시에도 안전
- 코드 간결

C# 8.0 using 선언:
```csharp
using var connection = new MySqlConnection(connectionString);
connection.Open();
// 메서드 끝에서 자동으로 Dispose
```


========== 비동기 프로그래밍 ==========

UI 블로킹 방지:
```csharp
private async Task LoadDataAsync()
{
    DataTable dataTable = new DataTable();
    using (var connection = new MySqlConnection(connectionString))
    using (var command = new MySqlCommand("SELECT * FROM person", connection))
    {
        await connection.OpenAsync();
        var reader = await command.ExecuteReaderAsync();
        dataTable.Load(reader);
    }
    Grid.ItemsSource = dataTable.DefaultView;
}

private async void BtnInsert_OnClick(object sender, RoutedEventArgs e)
{
    await InsertDataAsync();
}

private async Task InsertDataAsync()
{
    using (var connection = new MySqlConnection(connectionString))
    using (var command = new MySqlCommand("INSERT INTO...", connection))
    {
        await connection.OpenAsync();
        await command.ExecuteNonQueryAsync();
    }
    await LoadDataAsync();
}
```

장점:
- UI 응답성 유지
- 사용자 경험 향상
- 권장 패턴 (WPF)


========== 개선 사항 ==========

1. 강타입 모델:
```csharp
public class Person
{
    public int ID { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
    public string Address { get; set; }
}

ObservableCollection<Person> persons = new ObservableCollection<Person>();
Grid.ItemsSource = persons;
```

2. Repository 패턴:
```csharp
public interface IPersonRepository
{
    Task<List<Person>> GetAllAsync();
    Task<Person> GetByIdAsync(int id);
    Task InsertAsync(Person person);
    Task UpdateAsync(Person person);
    Task DeleteAsync(int id);
}

public class PersonRepository : IPersonRepository
{
    private readonly string _connectionString;
    
    public PersonRepository(string connectionString)
    {
        _connectionString = connectionString;
    }
    
    public async Task<List<Person>> GetAllAsync()
    {
        var persons = new List<Person>();
        using (var connection = new MySqlConnection(_connectionString))
        using (var command = new MySqlCommand("SELECT * FROM person", connection))
        {
            await connection.OpenAsync();
            var reader = await command.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                persons.Add(new Person
                {
                    ID = reader.GetInt32("ID"),
                    Name = reader.GetString("Name"),
                    Age = reader.GetInt32("Age"),
                    Address = reader.GetString("Address")
                });
            }
        }
        return persons;
    }
    
    // 다른 메서드들...
}
```

3. MVVM 패턴:
```csharp
public class PersonViewModel : INotifyPropertyChanged
{
    private readonly IPersonRepository _repository;
    
    public ObservableCollection<Person> Persons { get; set; }
    public ICommand InsertCommand { get; }
    public ICommand UpdateCommand { get; }
    public ICommand DeleteCommand { get; }
    
    public PersonViewModel(IPersonRepository repository)
    {
        _repository = repository;
        InsertCommand = new RelayCommand(async () => await InsertAsync());
        // ...
    }
    
    private async Task LoadDataAsync()
    {
        var data = await _repository.GetAllAsync();
        Persons = new ObservableCollection<Person>(data);
        OnPropertyChanged(nameof(Persons));
    }
}
```

4. Dependency Injection:
```csharp
public partial class App : Application
{
    protected override void OnStartup(StartupEventArgs e)
    {
        var services = new ServiceCollection();
        services.AddSingleton<IPersonRepository>(
            new PersonRepository(connectionString));
        services.AddTransient<PersonViewModel>();
        services.AddTransient<MainWindow>();
        
        var serviceProvider = services.BuildServiceProvider();
        var mainWindow = serviceProvider.GetRequiredService<MainWindow>();
        mainWindow.Show();
    }
}
```

5. Entity Framework Core (ORM):
```csharp
public class AppDbContext : DbContext
{
    public DbSet<Person> Persons { get; set; }
    
    protected override void OnConfiguring(DbContextOptionsBuilder options)
    {
        options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString));
    }
}

// 사용
var persons = await dbContext.Persons.ToListAsync();
dbContext.Persons.Add(new Person { Name = "홍길동", Age = 30, Address = "서울" });
await dbContext.SaveChangesAsync();
```

6. Dapper (Micro ORM):
```csharp
using (var connection = new MySqlConnection(connectionString))
{
    var persons = await connection.QueryAsync<Person>("SELECT * FROM person");
    
    await connection.ExecuteAsync(
        "INSERT INTO person(Name, Age, Address) VALUES (@Name, @Age, @Address)",
        new { Name = "홍길동", Age = 30, Address = "서울" });
}
```


========== 보안 모범 사례 ==========

1. 매개변수화된 쿼리:
   - SQL Injection 방지
   - 필수

2. 연결 문자열 보안:
   - 소스 코드에 하드코딩 금지
   - appsettings.json, 환경 변수, User Secrets

3. SSL/TLS 연결:
   - SslMode=Required
   - 데이터 암호화

4. 최소 권한 원칙:
   - root 계정 사용 금지
   - 애플리케이션 전용 사용자 생성

5. 입력 검증:
   - 클라이언트 + 서버
   - 데이터 타입, 길이, 범위

6. 오류 처리:
   - 상세한 오류 메시지 노출 금지
   - 로그 기록


========== 성능 최적화 ==========

1. 연결 풀링:
   - 기본 활성화
   - 연결 재사용
   - MinPoolSize=0, MaxPoolSize=100

2. 비동기 메서드:
   - UI 블로킹 방지
   - OpenAsync(), ExecuteReaderAsync()

3. 필요한 컬럼만 조회:
   - SELECT ID, Name FROM person
   - SELECT * 지양

4. 인덱스 사용:
   - CREATE INDEX idx_name ON person(Name)
   - 검색 성능 향상

5. 트랜잭션 최소화:
   - 가능한 짧게
   - 데드락 방지

6. 배치 작업:
   - 여러 INSERT를 한 번에
   - MySqlBulkCopy


========== 실전 활용 ==========

1. 페이징:
```sql
SELECT * FROM person LIMIT 10 OFFSET 0  -- 1페이지
SELECT * FROM person LIMIT 10 OFFSET 10 -- 2페이지
```

2. 필터링:
```sql
SELECT * FROM person WHERE Age > 30
SELECT * FROM person WHERE Name LIKE '%홍%'
```

3. 정렬:
```sql
SELECT * FROM person ORDER BY Age DESC
SELECT * FROM person ORDER BY Name ASC, Age DESC
```

4. 집계:
```sql
SELECT COUNT(*) FROM person
SELECT AVG(Age) FROM person
SELECT MAX(Age), MIN(Age) FROM person
```

5. 조인:
```sql
SELECT p.*, c.CityName 
FROM person p 
INNER JOIN city c ON p.CityID = c.ID
```


========== 요약 ==========

WPF MariaDB 연동의 핵심:

1. MySqlConnector 패키지 설치
2. 연결 문자열 설정
3. MySqlConnection, MySqlCommand 사용
4. 매개변수화된 쿼리 (보안)
5. DataTable + DataGrid (표시)
6. try-catch-finally (예외 처리)
7. using 문 (리소스 관리)
8. 비동기 메서드 (UI 응답성)

발전 방향:
- MVVM 패턴 적용
- Repository 패턴
- Entity Framework Core/Dapper
- Dependency Injection
- 단위 테스트

이 예제는 기본 ADO.NET 사용법을 보여줍니다.
실무에서는 ORM, MVVM, DI 등 고급 패턴을 사용합니다.
