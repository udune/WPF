using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace ch13_익스팬더
{
    /// <summary>
    /// MainWindow.xaml에 대한 상호작용 논리
    /// Expander 컨트롤의 Expanded 이벤트를 처리하는 메인 윈도우
    /// </summary>
    public partial class MainWindow : Window
    {
        /// <summary>
        /// MainWindow 생성자
        /// 윈도우가 생성될 때 호출되어 초기화 작업을 수행합니다.
        /// </summary>
        public MainWindow()
        {
            // XAML에 정의된 UI 요소들을 초기화합니다.
            InitializeComponent();
        }

        /// <summary>
        /// Expander의 Expanded 이벤트 핸들러
        /// 사용자가 Expander를 펼칠 때(확장할 때) 실행됩니다.
        /// </summary>
        /// <param name="sender">이벤트를 발생시킨 객체 (여기서는 Expander)</param>
        /// <param name="e">라우팅 이벤트 정보를 담고 있는 인자</param>
        private void Expander_Expanded(object sender, RoutedEventArgs e)
        {
            // Expander가 펼쳐질 때 경고 메시지를 표시합니다.
            MessageBox.Show("관리자 권한 입니다.");
            
            /*
             * 동작 설명:
             * 
             * 1. 사용자가 "확장" Expander의 헤더를 클릭
             * 2. Expander가 접힌 상태에서 펼쳐진 상태로 변경됨 (IsExpanded: false → true)
             * 3. Expanded 이벤트가 발생하여 이 메서드 실행
             * 4. MessageBox가 표시되어 "관리자 권한 입니다." 메시지를 보여줌
             * 5. 사용자가 확인을 클릭하면 Expander의 내용이 표시됨
             * 
             * 사용 사례:
             * - 고급 기능이나 관리자 전용 옵션을 펼칠 때 경고 표시
             * - 중요한 설정을 변경하기 전에 확인 요청
             * - 민감한 정보를 표시할 때 알림 제공
             * - 추가 비용이 발생하는 옵션을 펼칠 때 안내
             * 
             * 실전 활용:
             * - 디버그 옵션 펼침 시 경고
             * - 관리자 설정 접근 시 권한 확인
             * - 과금 정보 표시 전 안내
             * - 위험한 작업 수행 전 주의사항 표시
             */
        }
        
        /*
         * Expander 이벤트 처리 추가 예제:
         * 
         * 1. Collapsed 이벤트 (접힐 때):
         * 
         *    private void Expander_Collapsed(object sender, RoutedEventArgs e)
         *    {
         *        MessageBox.Show("Expander가 접혔습니다.");
         *        
         *        // 또는 다른 처리
         *        statusLabel.Text = "옵션이 숨겨졌습니다.";
         *    }
         * 
         * 2. 상태에 따른 다른 처리:
         * 
         *    private void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expander)
         *        {
         *            string header = expander.Header?.ToString() ?? "";
         *            
         *            switch (header)
         *            {
         *                case "고급 설정":
         *                    MessageBox.Show("주의: 고급 설정을 변경하면 프로그램이 불안정해질 수 있습니다.");
         *                    break;
         *                    
         *                case "관리자 옵션":
         *                    if (!IsAdmin())
         *                    {
         *                        MessageBox.Show("관리자 권한이 필요합니다.", "권한 오류");
         *                        expander.IsExpanded = false; // 다시 접기
         *                    }
         *                    break;
         *            }
         *        }
         *    }
         *    
         *    private bool IsAdmin()
         *    {
         *        // 권한 확인 로직
         *        return true;
         *    }
         * 
         * 3. 지연 로드 (Lazy Loading):
         * 
         *    private void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expander && expander.Content == null)
         *        {
         *            // 처음 펼칠 때만 내용을 동적으로 생성
         *            StackPanel panel = new StackPanel();
         *            
         *            // 데이터베이스에서 데이터 로드
         *            var data = LoadDataFromDatabase();
         *            
         *            foreach (var item in data)
         *            {
         *                panel.Children.Add(new TextBlock { Text = item.Name });
         *            }
         *            
         *            expander.Content = panel;
         *        }
         *    }
         *    
         *    private List<DataItem> LoadDataFromDatabase()
         *    {
         *        // 실제 데이터베이스 조회
         *        return new List<DataItem>();
         *    }
         * 
         * 4. 여러 Expander 중 하나만 펼치기 (Accordion 스타일):
         * 
         *    private void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expandedExpander)
         *        {
         *            // 부모 StackPanel의 모든 Expander를 찾아서 접기
         *            if (expandedExpander.Parent is StackPanel parent)
         *            {
         *                foreach (var child in parent.Children)
         *                {
         *                    if (child is Expander expander && expander != expandedExpander)
         *                    {
         *                        expander.IsExpanded = false;
         *                    }
         *                }
         *            }
         *        }
         *    }
         * 
         * 5. 통계 기록:
         * 
         *    private Dictionary<string, int> expandCount = new Dictionary<string, int>();
         *    
         *    private void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expander)
         *        {
         *            string header = expander.Header?.ToString() ?? "Unknown";
         *            
         *            if (!expandCount.ContainsKey(header))
         *            {
         *                expandCount[header] = 0;
         *            }
         *            
         *            expandCount[header]++;
         *            
         *            // 로그 기록
         *            System.Diagnostics.Debug.WriteLine($"{header} 펼침 횟수: {expandCount[header]}");
         *        }
         *    }
         * 
         * 6. 애니메이션 또는 효과 추가:
         * 
         *    private void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expander && expander.Content is UIElement content)
         *        {
         *            // 페이드 인 애니메이션
         *            content.Opacity = 0;
         *            
         *            DoubleAnimation fadeIn = new DoubleAnimation
         *            {
         *                From = 0,
         *                To = 1,
         *                Duration = TimeSpan.FromMilliseconds(300)
         *            };
         *            
         *            content.BeginAnimation(UIElement.OpacityProperty, fadeIn);
         *        }
         *    }
         * 
         * 7. 사용자 설정 저장:
         * 
         *    private void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expander)
         *        {
         *            string name = expander.Name;
         *            Properties.Settings.Default[$"{name}_IsExpanded"] = true;
         *            Properties.Settings.Default.Save();
         *        }
         *    }
         *    
         *    private void Expander_Collapsed(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expander)
         *        {
         *            string name = expander.Name;
         *            Properties.Settings.Default[$"{name}_IsExpanded"] = false;
         *            Properties.Settings.Default.Save();
         *        }
         *    }
         *    
         *    private void LoadExpanderStates()
         *    {
         *        // Window 로드 시 호출
         *        foreach (var child in mainStackPanel.Children)
         *        {
         *            if (child is Expander expander)
         *            {
         *                string name = expander.Name;
         *                if (Properties.Settings.Default.PropertyValues[name + "_IsExpanded"] != null)
         *                {
         *                    expander.IsExpanded = (bool)Properties.Settings.Default[name + "_IsExpanded"];
         *                }
         *            }
         *        }
         *    }
         * 
         * 8. 비동기 데이터 로드:
         * 
         *    private async void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (sender is Expander expander)
         *        {
         *            if (expander.Content == null)
         *            {
         *                // 로딩 표시
         *                expander.Content = new TextBlock { Text = "로딩 중..." };
         *                
         *                // 비동기로 데이터 로드
         *                var data = await LoadDataAsync();
         *                
         *                // UI 업데이트
         *                StackPanel panel = new StackPanel();
         *                foreach (var item in data)
         *                {
         *                    panel.Children.Add(new TextBlock { Text = item });
         *                }
         *                
         *                expander.Content = panel;
         *            }
         *        }
         *    }
         *    
         *    private async Task<List<string>> LoadDataAsync()
         *    {
         *        await Task.Delay(1000); // 시뮬레이션
         *        return new List<string> { "항목1", "항목2", "항목3" };
         *    }
         * 
         * 9. 조건부 펼침 방지:
         * 
         *    private void Expander_Expanding(object sender, RoutedEventArgs e)
         *    {
         *        // Expanding 이벤트는 기본적으로 제공되지 않으므로
         *        // PreviewMouseDown 이벤트를 사용하거나
         *        // IsExpanded 속성 변경을 감지해야 함
         *    }
         *    
         *    private bool isProcessing = false;
         *    
         *    private void Expander_Expanded(object sender, RoutedEventArgs e)
         *    {
         *        if (isProcessing)
         *        {
         *            MessageBox.Show("다른 작업이 진행 중입니다.");
         *            if (sender is Expander expander)
         *            {
         *                expander.IsExpanded = false;
         *            }
         *            return;
         *        }
         *        
         *        // 정상 처리
         *        MessageBox.Show("Expander가 펼쳐졌습니다.");
         *    }
         * 
         * 10. 상태 표시:
         * 
         *     private void Expander_Expanded(object sender, RoutedEventArgs e)
         *     {
         *         if (sender is Expander expander)
         *         {
         *             statusBar.Text = $"{expander.Header} 섹션이 열렸습니다.";
         *             
         *             // 헤더에 상태 아이콘 추가
         *             if (expander.Header is Panel headerPanel)
         *             {
         *                 // 열림 표시 아이콘 추가
         *             }
         *         }
         *     }
         *     
         *     private void Expander_Collapsed(object sender, RoutedEventArgs e)
         *     {
         *         if (sender is Expander expander)
         *         {
         *             statusBar.Text = $"{expander.Header} 섹션이 닫혔습니다.";
         *         }
         *     }
         * 
         * Expander 이벤트 관련 중요 사항:
         * 
         * 1. Expanded 이벤트 발생 시점:
         *    - 사용자가 헤더를 클릭하여 펼칠 때
         *    - 코드에서 IsExpanded = true로 설정할 때
         *    - 이미 펼쳐진 상태에서는 발생하지 않음
         * 
         * 2. Collapsed 이벤트 발생 시점:
         *    - 사용자가 헤더를 클릭하여 접을 때
         *    - 코드에서 IsExpanded = false로 설정할 때
         *    - 이미 접힌 상태에서는 발생하지 않음
         * 
         * 3. 이벤트 순서:
         *    - Expanded → Content 렌더링
         *    - Collapsed → Content 숨김 (렌더링 중지)
         * 
         * 4. 성능 고려사항:
         *    - Expanded 이벤트에서 무거운 작업을 수행할 수 있음
         *    - 접힌 상태에서는 Content가 렌더링되지 않으므로 성능 절약
         *    - 필요할 때만 데이터를 로드하는 지연 로드 패턴 사용
         * 
         * 5. 사용자 경험:
         *    - 펼침/접힘 시 부드러운 애니메이션 제공 (WPF 기본 제공)
         *    - MessageBox는 사용자 흐름을 방해할 수 있으므로 신중히 사용
         *    - 대신 StatusBar나 ToolTip으로 정보 제공 고려
         * 
         * 6. Expander 식별:
         *    - sender를 Expander로 캐스팅하여 속성 접근
         *    - Name, Header, Tag 속성으로 구분
         *    - 여러 Expander가 같은 핸들러를 공유할 수 있음
         * 
         * 7. 상태 관리:
         *    - IsExpanded 속성으로 현재 상태 확인
         *    - 데이터 바인딩으로 ViewModel과 연동 가능
         *    - 설정 파일에 상태 저장하여 다음 실행 시 복원
         * 
         * 8. 예외 처리:
         *    - 이벤트 핸들러 내에서 예외가 발생하면 적절히 처리
         *    - 사용자에게 명확한 오류 메시지 제공
         *    - 예외 발생 시에도 Expander 상태가 일관되도록 관리
         * 
         * 예제 - 예외 처리:
         * 
         * private void Expander_Expanded(object sender, RoutedEventArgs e)
         * {
         *     try
         *     {
         *         // 데이터 로드 또는 처리
         *         LoadData();
         *     }
         *     catch (Exception ex)
         *     {
         *         MessageBox.Show($"오류가 발생했습니다: {ex.Message}", "오류",
         *             MessageBoxButton.OK, MessageBoxImage.Error);
         *         
         *         // Expander를 다시 접기
         *         if (sender is Expander expander)
         *         {
         *             expander.IsExpanded = false;
         *         }
         *     }
         * }
         * 
         * 9. MVVM 패턴:
         *    - IsExpanded를 ViewModel 속성에 바인딩
         *    - Command 패턴 사용 고려
         *    - 이벤트 핸들러 대신 바인딩으로 처리
         * 
         * MVVM 예제:
         * 
         * XAML:
         * <Expander IsExpanded="{Binding IsAdvancedSettingsExpanded}">
         * 
         * ViewModel:
         * private bool _isAdvancedSettingsExpanded;
         * public bool IsAdvancedSettingsExpanded
         * {
         *     get => _isAdvancedSettingsExpanded;
         *     set
         *     {
         *         _isAdvancedSettingsExpanded = value;
         *         OnPropertyChanged();
         *         
         *         if (value)
         *         {
         *             // 펼쳐졌을 때 처리
         *             LoadAdvancedSettings();
         *         }
         *     }
         * }
         * 
         * 10. 디버깅 팁:
         *     - Expanded/Collapsed 이벤트에 중단점 설정
         *     - IsExpanded 속성 변경 추적
         *     - 로그 기록으로 사용자 행동 분석
         */